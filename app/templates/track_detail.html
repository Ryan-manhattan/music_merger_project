{% extends "base.html" %}

{% block title %}{{ track.title }} - OFF THE COMMUNITY{% endblock %}

{% block content %}
<div class="main-content-container">
    <header class="mb-12">
        <a href="{{ url_for('index') }}" class="text-[10px] uppercase tracking-[0.2em] opacity-40 hover:opacity-80 inline-flex items-center gap-2">
            <span>â†</span><span>BACK_TO_SONGS</span>
        </a>

        <div class="inline-flex items-center gap-4 mt-8 mb-6">
            <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">Track_ID: {{ track.id[:8] if track.id else 'NULL' }}</span>
            <div class="w-12 h-[1px] bg-white/20"></div>
        </div>

        <h2 class="text-4xl md:text-5xl font-bold serif-font leading-tight mb-3">{{ track.title }}</h2>
        <div class="text-[11px] uppercase tracking-widest opacity-50">
            {% if track.artist %}{{ track.artist }}{% endif %}
            {% if track.duration_str %} Â· {{ track.duration_str }}{% endif %}
            Â· {{ track.source }}
        </div>
    </header>

    <section class="pixel-card !p-0 overflow-hidden mb-10">
        <div class="flex flex-col md:flex-row">
            <!-- Large Interactive Cover -->
            <div class="w-full md:w-1/3 aspect-square relative group bg-black">
                {% if track.thumbnail_url %}
                    <img src="{{ track.thumbnail_url }}" alt="cover" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                {% else %}
                    <div class="w-full h-full flex items-center justify-center opacity-20">
                        <span class="text-4xl">ğŸµ</span>
                    </div>
                {% endif %}
                
                <div class="absolute bottom-4 left-4">
                    <span class="text-[9px] bg-black/60 px-2 py-1 uppercase tracking-widest border border-white/10">
                        Archive_Ready
                    </span>
                </div>
            </div>

            <!-- Track Meta Data -->
            <div class="flex-1 p-8 md:p-12 flex flex-col justify-center">
                <div class="inline-flex items-center gap-4 mb-6">
                    <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">Playback_Node</span>
                    <div class="w-12 h-[1px] bg-white/20"></div>
                </div>
                
                <h3 class="text-3xl font-bold serif-font mb-4">{{ track.title }}</h3>
                <p class="text-sm opacity-50 mb-8 uppercase tracking-widest">
                    {% if track.artist %}{{ track.artist }}{% endif %} 
                    {% if track.duration_str %} Â· {{ track.duration_str }}{% endif %}
                </p>

                <!-- Playback Action -->
                <div class="mb-10">
                    <button class="btn-pixel !px-8 flex items-center gap-4 group" 
                            onclick="{% if embed.type == 'soundcloud' %}playInGlobalPlayer('{{ track.url }}', '{{ track.title }}'){% else %}activateYouTube(){% endif %}">
                        <span class="group-hover:translate-x-1 transition-transform">â–¶</span>
                        <span class="text-[10px] tracking-[0.3em]">INITIALIZE_SYSTEM_PLAYER</span>
                    </button>
                </div>

                <div class="flex flex-wrap gap-4 mt-auto">
                    <div class="text-[9px] border border-white/5 px-3 py-1.5 uppercase opacity-30">
                        Source: {{ track.source }}
                    </div>
                    <div class="text-[9px] border border-white/5 px-3 py-1.5 uppercase opacity-30">
                        Node_ID: {{ track.id[:8] }}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Hidden YouTube Player Container -->
    <div id="youtubePlayer" class="aspect-video bg-black border-4 border-white mb-10 hidden">
        <iframe
            id="ytIframe"
            title="YouTube player"
            width="100%"
            height="100%"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            src="">
        </iframe>
    </div>


    <section class="pixel-card p-6 md:p-10 mb-10">
        <h3 class="text-xs uppercase tracking-[0.3em] opacity-40 mb-6">Leave a Comment</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input
                type="text"
                id="commentAuthor"
                maxlength="50"
                placeholder="ë‹‰ë„¤ì„(ì„ íƒ)"
                class="bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-pixel"
            >
            <div class="md:col-span-2">
                <textarea
                    id="commentContent"
                    maxlength="4000"
                    placeholder="ì´ ê³¡ì„ ë“¤ìœ¼ë©° ë– ì˜¤ë¥¸ ìƒê°ì„ ììœ ë¡­ê²Œ ë‚¨ê²¨ì£¼ì„¸ìš”."
                    class="w-full bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-serif min-h-40"
                ></textarea>
                <div class="text-[10px] mt-2 opacity-40 uppercase tracking-widest text-right">
                    <span id="commentCount">0</span> / 4000
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-6">
            <button class="btn-pixel text-xs tracking-widest" id="commentSubmitBtn" onclick="submitComment()">SAVE_COMMENT</button>
        </div>
        <div id="commentMsg" class="text-xs mt-4 opacity-70"></div>
    </section>

    <section class="space-y-6">
        <div class="flex items-end justify-between">
            <h3 class="text-xs uppercase tracking-[0.3em] opacity-40">Comments</h3>
            <div class="text-[10px] opacity-40 uppercase tracking-widest">{{ comments|length }} items</div>
        </div>

        {% if comments %}
            {% for c in comments %}
                <article class="pixel-card p-6">
                    <div class="flex justify-between items-start gap-4">
                        <div class="text-[10px] uppercase tracking-widest opacity-40">
                            {{ c.author }} Â· {{ c.created_at[:10] if c.created_at else '' }}
                        </div>
                        <button class="btn-outline text-[10px] tracking-widest" onclick="openDeleteModal('{{ c.id }}')">DELETE</button>
                    </div>
                    <div class="mt-4 text-base serif-font leading-relaxed whitespace-pre-wrap">
                        {{ c.content }}
                    </div>
                </article>
            {% endfor %}
        {% else %}
            <div class="pixel-card p-10 text-center">
                <h3 class="text-xl serif-font mb-2">ì•„ì§ ì½”ë©˜íŠ¸ê°€ ì—†ì–´ìš”</h3>
                <p class="text-sm opacity-50 italic serif-font">ì²« ë²ˆì§¸ ê°ìƒì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<!-- ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
    <div class="pixel-card p-6 md:p-8 max-w-sm w-full mx-4">
        <h3 class="text-sm uppercase tracking-[0.3em] mb-6">ê´€ë¦¬ì ì¸ì¦</h3>
        <input
            type="password"
            id="deletePasswordInput"
            placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
            class="w-full bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-pixel mb-4"
        >
        <div id="deleteModalError" class="text-xs text-red-400 mb-4 hidden"></div>
        <div class="flex gap-3">
            <button class="btn-outline text-xs tracking-widest flex-1" onclick="closeDeleteModal()">CANCEL</button>
            <button class="btn-pixel text-xs tracking-widest flex-1" id="deleteConfirmBtn" onclick="confirmDelete()">DELETE</button>
        </div>
    </div>
</div>

<script>
let pendingDeleteCommentId = null;

function openDeleteModal(commentId) {
    pendingDeleteCommentId = commentId;
    document.getElementById('deletePasswordInput').value = '';
    document.getElementById('deleteModalError').classList.add('hidden');
    document.getElementById('deleteModal').classList.remove('hidden');
    document.getElementById('deletePasswordInput').focus();
}

function closeDeleteModal() {
    pendingDeleteCommentId = null;
    document.getElementById('deleteModal').classList.add('hidden');
}

async function confirmDelete() {
    const pw = document.getElementById('deletePasswordInput').value.trim();
    const errorEl = document.getElementById('deleteModalError');
    const btn = document.getElementById('deleteConfirmBtn');
    
    if (!pw) {
        errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        errorEl.classList.remove('hidden');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'DELETING...';
    errorEl.classList.add('hidden');
    
    try {
        const res = await fetch(`/api/track_comments/${pendingDeleteCommentId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password: pw})
        });
        const data = await res.json();
        if (data.success) {
            closeDeleteModal();
            window.location.reload();
            return;
        }
        errorEl.textContent = data.error || 'ì‚­ì œ ì‹¤íŒ¨';
        errorEl.classList.remove('hidden');
    } catch (e) {
        errorEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.';
        errorEl.classList.remove('hidden');
    } finally {
        btn.disabled = false;
        btn.textContent = 'DELETE';
    }
}

// Enter í‚¤ë¡œ ì‚­ì œ í™•ì¸
document.getElementById('deletePasswordInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') confirmDelete();
    if (e.key === 'Escape') closeDeleteModal();
});

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('deleteModal').addEventListener('click', (e) => {
    if (e.target.id === 'deleteModal') closeDeleteModal();
});

function renderAddedAtLocal() {
    const el = document.getElementById('addedAtLocal');
    if (!el) return;
    const iso = (el.getAttribute('data-iso') || '').trim();
    if (!iso) return;
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return;
    el.textContent = d.toLocaleString();
}

function activateYouTube() {
    const player = document.getElementById('youtubePlayer');
    const iframe = document.getElementById('ytIframe');
    
    console.log('[Player] activateYouTube called');
    
    if (player && iframe) {
        player.classList.remove('hidden');
        iframe.src = "https://www.youtube.com/embed/{{ embed.source_id }}?autoplay=1";
        console.log('[Player] YouTube iframe src set');
    } else {
        console.log('[Player] YouTube elements not found');
    }
}

const contentEl = document.getElementById('commentContent');
const countEl = document.getElementById('commentCount');
contentEl.addEventListener('input', () => { countEl.textContent = (contentEl.value || '').length; });
renderAddedAtLocal();

async function submitComment() {
    const btn = document.getElementById('commentSubmitBtn');
    const msg = document.getElementById('commentMsg');
    const author = (document.getElementById('commentAuthor').value || '').trim() || 'Anonymous';
    const content = (document.getElementById('commentContent').value || '').trim();

    if (!content) {
        msg.textContent = 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'SAVING...';
    msg.textContent = '';

    try {
        const res = await fetch('/api/tracks/{{ track.id }}/comments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({author, content})
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
            return;
        }
        msg.textContent = data.error || 'ì €ì¥ ì‹¤íŒ¨';
    } catch (e) {
        msg.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'SAVE_COMMENT';
    }
}

</script>
{% endblock %}

