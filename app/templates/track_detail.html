{% extends "base.html" %}

{% block title %}{{ track.title }} - OFF THE COMMUNITY{% endblock %}

{% block content %}
<div class="main-content-container">
    <header class="mb-12">
        {% if track.playlist_id %}
        <a href="{{ url_for('playlist_detail', playlist_id=track.playlist_id) }}" class="text-[10px] uppercase tracking-[0.2em] opacity-40 hover:opacity-80 inline-flex items-center gap-2">
            <span>â†</span><span>BACK_TO_PLAYLIST</span>
        </a>
        {% else %}
        <a href="{{ url_for('playlists') }}" class="text-[10px] uppercase tracking-[0.2em] opacity-40 hover:opacity-80 inline-flex items-center gap-2">
            <span>â†</span><span>BACK_TO_PLAYLISTS</span>
        </a>
        {% endif %}

        <div class="inline-flex items-center gap-4 mt-8 mb-6">
            <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">Track_ID: {{ track.id[:8] if track.id else 'NULL' }}</span>
            <div class="w-12 h-[1px] bg-white/20"></div>
        </div>

        <h2 class="text-4xl md:text-5xl font-bold serif-font leading-tight mb-3">{{ track.title }}</h2>
        <div class="text-[11px] uppercase tracking-widest opacity-50">
            {% if track.artist %}{{ track.artist }}{% endif %}
            {% if track.duration_str %} Â· {{ track.duration_str }}{% endif %}
            Â· {{ track.source }}
        </div>
    </header>

    <section class="pixel-card !p-0 overflow-hidden mb-10">
        <div class="flex flex-col md:flex-row">
            <!-- Large Interactive Cover -->
            <div class="w-full md:w-1/3 aspect-square relative group bg-black">
                {% if track.thumbnail_url %}
                    <img src="{{ track.thumbnail_url }}" alt="cover" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                {% else %}
                    <div class="w-full h-full flex items-center justify-center opacity-20">
                        <span class="text-4xl">ğŸµ</span>
                    </div>
                {% endif %}
                
                <div class="absolute bottom-4 left-4">
                    <span class="text-[9px] bg-black/60 px-2 py-1 uppercase tracking-widest border border-white/10">
                        Archive_Ready
                    </span>
                </div>
            </div>

            <!-- Track Meta Data -->
            <div class="flex-1 p-8 md:p-12 flex flex-col justify-center relative">
                <!-- ê°„ë‹¨í•œ ë©”íƒ€ë°ì´í„° (ì˜¤ë¥¸ìª½ ìƒë‹¨) -->
                <div class="absolute top-8 right-8 flex flex-col gap-2 items-end">
                    <div class="text-[9px] border border-white/5 px-3 py-1.5 uppercase opacity-30">
                        Source: {{ track.source }}
                    </div>
                    <div class="text-[9px] border border-white/5 px-3 py-1.5 uppercase opacity-30">
                        Node_ID: {{ track.id[:8] }}
                    </div>
                    {% if track.duration_str %}
                    <div class="text-[9px] border border-white/5 px-3 py-1.5 uppercase opacity-30">
                        Duration: {{ track.duration_str }}
                    </div>
                    {% endif %}
                    {% if track.artist %}
                    <div class="text-[9px] border border-white/5 px-3 py-1.5 uppercase opacity-30">
                        Artist: {{ track.artist }}
                    </div>
                    {% endif %}
                </div>
                <div class="inline-flex items-center gap-4 mb-6">
                    <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">Playback_Node</span>
                    <div class="w-12 h-[1px] bg-white/20"></div>
                </div>
                
                <h3 class="text-3xl font-bold serif-font mb-4">{{ track.title }}</h3>
                <p class="text-sm opacity-50 mb-8 uppercase tracking-widest">
                    {% if track.artist %}{{ track.artist }}{% endif %} 
                    {% if track.duration_str %} Â· {{ track.duration_str }}{% endif %}
                </p>

                <!-- Playback Action -->
                <div class="mb-10">
                    {% if embed.type == 'soundcloud' %}
                    <button class="btn-pixel !px-8 flex items-center gap-4 group" 
                            onclick="showSoundCloudPlayer()">
                        <span class="group-hover:translate-x-1 transition-transform">â–¶</span>
                        <span class="text-[10px] tracking-[0.3em]">INITIALIZE_SYSTEM_PLAYER</span>
                    </button>
                    {% else %}
                    <button class="btn-pixel !px-8 flex items-center gap-4 group" 
                            onclick="activateYouTube()">
                        <span class="group-hover:translate-x-1 transition-transform">â–¶</span>
                        <span class="text-[10px] tracking-[0.3em]">INITIALIZE_SYSTEM_PLAYER</span>
                    </button>
                    {% endif %}
                </div>

            </div>
        </div>
    </section>

    <!-- YouTube Player Container -->
    <div id="youtubePlayer" class="aspect-video bg-black border-4 border-white mb-10 hidden">
        <iframe
            id="ytIframe"
            title="YouTube player"
            width="100%"
            height="100%"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            src="">
        </iframe>
    </div>

    <!-- SoundCloud Player Container -->
    {% if embed.type == 'soundcloud' %}
    <section class="pixel-card p-6 md:p-10 mb-10" id="soundcloudPlayerSection">
        <div class="inline-flex items-center gap-4 mb-6">
            <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">SoundCloud_Player</span>
            <div class="w-12 h-[1px] bg-white/20"></div>
        </div>
        <iframe
            id="soundcloudPlayer"
            width="100%"
            height="166"
            scrolling="no"
            frameborder="no"
            allow="autoplay"
            src="">
        </iframe>
    </section>
    {% endif %}


    <section class="pixel-card p-6 md:p-10 mb-10">
        <h3 class="text-xs uppercase tracking-[0.3em] opacity-40 mb-6">Leave a Comment</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% if current_user.is_authenticated %}
            <input
                type="text"
                id="commentAuthor"
                maxlength="50"
                value="{{ current_user.username }}"
                placeholder="{{ current_user.username }}"
                class="bg-black border-2 border-[#333] p-4 text-sm focus:border-white outline-none font-pixel"
                readonly
                style="opacity: 0.7; cursor: not-allowed;"
            >
            {% else %}
            <input
                type="text"
                id="commentAuthor"
                maxlength="50"
                placeholder="ë‹‰ë„¤ì„(ì„ íƒ)"
                class="bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-pixel"
            >
            {% endif %}
            <div class="md:col-span-2">
                <textarea
                    id="commentContent"
                    maxlength="4000"
                    placeholder="ì´ ê³¡ì„ ë“¤ìœ¼ë©° ë– ì˜¤ë¥¸ ìƒê°ì„ ììœ ë¡­ê²Œ ë‚¨ê²¨ì£¼ì„¸ìš”."
                    class="w-full bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-serif min-h-40"
                ></textarea>
                <div class="text-[10px] mt-2 opacity-40 uppercase tracking-widest text-right">
                    <span id="commentCount">0</span> / 4000
                </div>
            </div>
        </div>
        <div class="flex justify-end mt-6">
            <button class="btn-pixel text-xs tracking-widest" id="commentSubmitBtn" onclick="submitComment()">SAVE_COMMENT</button>
        </div>
        <div id="commentMsg" class="text-xs mt-4 opacity-70"></div>
    </section>

    <section class="space-y-6">
        <div class="flex items-end justify-between">
            <h3 class="text-xs uppercase tracking-[0.3em] opacity-40">Comments</h3>
            <div class="text-[10px] opacity-40 uppercase tracking-widest">{{ comments|length }} items</div>
        </div>

        {% if comments %}
            {% for c in comments %}
                <article class="pixel-card p-6">
                    <div class="flex justify-between items-start gap-4">
                        <div class="text-[10px] uppercase tracking-widest opacity-40">
                            {{ c.author }} Â· {{ c.created_at[:10] if c.created_at else '' }}
                        </div>
                        {% if current_user.is_authenticated and (c.user_id|string == current_user.id|string or (not c.user_id and c.author == current_user.username)) %}
                        <button class="btn-outline text-[10px] tracking-widest" onclick="confirmDeleteComment('{{ c.id }}')">DELETE</button>
                        {% endif %}
                    </div>
                    <div class="mt-4 text-base serif-font leading-relaxed whitespace-pre-wrap">
                        {{ c.content }}
                    </div>
                </article>
            {% endfor %}
        {% else %}
            <div class="pixel-card p-10 text-center">
                <h3 class="text-xl serif-font mb-2">ì•„ì§ ì½”ë©˜íŠ¸ê°€ ì—†ì–´ìš”</h3>
                <p class="text-sm opacity-50 italic serif-font">ì²« ë²ˆì§¸ ê°ìƒì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function confirmDeleteComment(commentId) {
    if (!confirm('ì •ë§ ì´ ì½”ë©˜íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const res = await fetch(`/api/track_comments/${commentId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (e) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

function renderAddedAtLocal() {
    const el = document.getElementById('addedAtLocal');
    if (!el) return;
    const iso = (el.getAttribute('data-iso') || '').trim();
    if (!iso) return;
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return;
    el.textContent = d.toLocaleString();
}

function activateYouTube() {
    const player = document.getElementById('youtubePlayer');
    const iframe = document.getElementById('ytIframe');
    
    console.log('[Player] activateYouTube called');
    
    if (player && iframe) {
        player.classList.remove('hidden');
        iframe.src = "https://www.youtube.com/embed/{{ embed.source_id }}?autoplay=1";
        console.log('[Player] YouTube iframe src set');
    } else {
        console.log('[Player] YouTube elements not found');
    }
}

function showSoundCloudPlayer() {
    const playerSection = document.getElementById('soundcloudPlayerSection');
    const iframe = document.getElementById('soundcloudPlayer');
    
    if (playerSection && iframe) {
        // SoundCloud í”Œë ˆì´ì–´ URL ì„¤ì •
        const trackUrl = '{{ track.url }}';
        if (!iframe.src) {
            iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(trackUrl)}&auto_play=true&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false&visual=true`;
        }
        // í”Œë ˆì´ì–´ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        playerSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ SoundCloud í”Œë ˆì´ì–´ ì´ˆê¸°í™”
{% if embed.type == 'soundcloud' %}
document.addEventListener('DOMContentLoaded', function() {
    const iframe = document.getElementById('soundcloudPlayer');
    if (iframe) {
        const trackUrl = '{{ track.url }}';
        iframe.src = `https://w.soundcloud.com/player/?url=${encodeURIComponent(trackUrl)}&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false&visual=true`;
    }
});
{% endif %}

const contentEl = document.getElementById('commentContent');
const countEl = document.getElementById('commentCount');
contentEl.addEventListener('input', () => { countEl.textContent = (contentEl.value || '').length; });
renderAddedAtLocal();

async function submitComment() {
    const btn = document.getElementById('commentSubmitBtn');
    const msg = document.getElementById('commentMsg');
    const authorInput = document.getElementById('commentAuthor');
    // ë¡œê·¸ì¸í•œ ê²½ìš° readonlyì´ë¯€ë¡œ value ì‚¬ìš©, ì•„ë‹ˆë©´ ì…ë ¥ê°’ ë˜ëŠ” Anonymous
    const author = authorInput ? (authorInput.value || '').trim() || 'Anonymous' : 'Anonymous';
    const content = (document.getElementById('commentContent').value || '').trim();

    if (!content) {
        msg.textContent = 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'SAVING...';
    msg.textContent = '';

    try {
        const res = await fetch('/api/tracks/{{ track.id }}/comments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({author, content})
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
            return;
        }
        msg.textContent = data.error || 'ì €ì¥ ì‹¤íŒ¨';
    } catch (e) {
        msg.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'SAVE_COMMENT';
    }
}

</script>
{% endblock %}

