{% extends "base.html" %}

{% block title %}{{ track.title }} - OFF THE COMMUNITY{% endblock %}

{% block content %}
<div class="main-content-container">
    <header class="mb-12">
        <a href="{{ url_for('index') }}" class="text-[10px] uppercase tracking-[0.2em] opacity-40 hover:opacity-80 inline-flex items-center gap-2">
            <span>â†</span><span>BACK_TO_SONGS</span>
        </a>

        <div class="inline-flex items-center gap-4 mt-8 mb-6">
            <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">Track_ID: {{ track.id[:8] if track.id else 'NULL' }}</span>
            <div class="w-12 h-[1px] bg-white/20"></div>
        </div>

        <h2 class="text-4xl md:text-5xl font-bold serif-font leading-tight mb-3">{{ track.title }}</h2>
        <div class="text-[11px] uppercase tracking-widest opacity-50">
            {% if track.artist %}{{ track.artist }}{% endif %}
            {% if track.duration_str %} Â· {{ track.duration_str }}{% endif %}
            Â· {{ track.source }}
        </div>
    </header>

    <section class="pixel-card !p-0 overflow-hidden mb-10">
        <div class="flex flex-col md:flex-row">
            <!-- Large Interactive Cover -->
            <div class="w-full md:w-1/3 aspect-square relative group bg-black">
                {% if track.thumbnail_url %}
                    <img src="{{ track.thumbnail_url }}" alt="cover" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
                {% else %}
                    <div class="w-full h-full flex items-center justify-center opacity-20">
                        <span class="text-4xl">ğŸµ</span>
                    </div>
                {% endif %}
                
                <div class="absolute bottom-4 left-4">
                    <span class="text-[9px] bg-black/60 px-2 py-1 uppercase tracking-widest border border-white/10">
                        Archive_Ready
                    </span>
                </div>
            </div>

            <!-- Track Meta Data -->
            <div class="flex-1 p-8 md:p-12 flex flex-col justify-center">
                <div class="inline-flex items-center gap-4 mb-6">
                    <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">Playback_Node</span>
                    <div class="w-12 h-[1px] bg-white/20"></div>
                </div>
                
                <h3 class="text-3xl font-bold serif-font mb-4">{{ track.title }}</h3>
                <p class="text-sm opacity-50 mb-8 uppercase tracking-widest">
                    {% if track.artist %}{{ track.artist }}{% endif %} 
                    {% if track.duration_str %} Â· {{ track.duration_str }}{% endif %}
                </p>

                <!-- Playback Action -->
                <div class="mb-10">
                    <button class="btn-pixel !px-8 flex items-center gap-4 group" 
                            onclick="{% if embed.type == 'soundcloud' %}playInGlobalPlayer('{{ track.url }}', '{{ track.title }}'){% else %}activateYouTube(){% endif %}">
                        <span class="group-hover:translate-x-1 transition-transform">â–¶</span>
                        <span class="text-[10px] tracking-[0.3em]">INITIALIZE_SYSTEM_PLAYER</span>
                    </button>
                </div>

                <div class="flex flex-wrap gap-4 mt-auto">
                    <div class="text-[9px] border border-white/5 px-3 py-1.5 uppercase opacity-30">
                        Source: {{ track.source }}
                    </div>
                    <div class="text-[9px] border border-white/5 px-3 py-1.5 uppercase opacity-30">
                        Node_ID: {{ track.id[:8] }}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Hidden YouTube Player Container -->
    <div id="youtubePlayer" class="aspect-video bg-black border-4 border-white mb-10 hidden">
        <iframe
            id="ytIframe"
            title="YouTube player"
            width="100%"
            height="100%"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
            src="">
        </iframe>
    </div>


    <section class="pixel-card p-6 md:p-10 mb-10">
        <h3 class="text-xs uppercase tracking-[0.3em] opacity-40 mb-8">ê°ì • ê¸°ë¡ (Emotion Diary)</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- ê°ì • ì„ íƒ -->
            <div>
                <label class="text-[10px] uppercase tracking-widest opacity-50 mb-4 block">í˜„ì¬ ê°ì •</label>
                <div class="grid grid-cols-3 gap-2">
                    <button type="button" class="emotion-btn text-2xl p-3 border-2 border-[#222] hover:border-white/50 transition-colors" data-emotion="happy">ğŸ˜Š</button>
                    <button type="button" class="emotion-btn text-2xl p-3 border-2 border-[#222] hover:border-white/50 transition-colors" data-emotion="sad">ğŸ˜¢</button>
                    <button type="button" class="emotion-btn text-2xl p-3 border-2 border-[#222] hover:border-white/50 transition-colors" data-emotion="excited">ğŸ¤©</button>
                    <button type="button" class="emotion-btn text-2xl p-3 border-2 border-[#222] hover:border-white/50 transition-colors" data-emotion="calm">ğŸ˜Œ</button>
                    <button type="button" class="emotion-btn text-2xl p-3 border-2 border-[#222] hover:border-white/50 transition-colors" data-emotion="angry">ğŸ˜ </button>
                    <button type="button" class="emotion-btn text-2xl p-3 border-2 border-[#222] hover:border-white/50 transition-colors" data-emotion="nostalgic">ğŸ¥º</button>
                </div>
                <input type="hidden" id="selectedEmotion">
            </div>

            <!-- ê°ì • ê°•ë„ -->
            <div>
                <label class="text-[10px] uppercase tracking-widest opacity-50 mb-4 block">ê°ì • ê°•ë„</label>
                <div class="flex items-center gap-2">
                    <span class="text-xs opacity-50">ì•½í•¨</span>
                    <div class="flex gap-1">
                        <input type="radio" name="intensity" value="1" id="int1" class="hidden">
                        <label for="int1" class="intensity-btn w-6 h-6 border border-[#222] cursor-pointer hover:border-white/50"></label>
                        <input type="radio" name="intensity" value="2" id="int2" class="hidden">
                        <label for="int2" class="intensity-btn w-6 h-6 border border-[#222] cursor-pointer hover:border-white/50"></label>
                        <input type="radio" name="intensity" value="3" id="int3" class="hidden" checked>
                        <label for="int3" class="intensity-btn w-6 h-6 border border-[#222] cursor-pointer hover:border-white/50 bg-white/20"></label>
                        <input type="radio" name="intensity" value="4" id="int4" class="hidden">
                        <label for="int4" class="intensity-btn w-6 h-6 border border-[#222] cursor-pointer hover:border-white/50"></label>
                        <input type="radio" name="intensity" value="5" id="int5" class="hidden">
                        <label for="int5" class="intensity-btn w-6 h-6 border border-[#222] cursor-pointer hover:border-white/50"></label>
                    </div>
                    <span class="text-xs opacity-50">ê°•í•¨</span>
                </div>
            </div>
        </div>

        <!-- ì²­ì·¨ í™˜ê²½ -->
        <div class="mb-8">
            <label class="text-[10px] uppercase tracking-widest opacity-50 mb-4 block">ì²­ì·¨ í™˜ê²½</label>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <select id="listenTime" class="bg-black border-2 border-[#222] p-3 text-sm focus:border-white outline-none font-pixel">
                    <option value="">ì‹œê°„ëŒ€</option>
                    <option value="dawn">ìƒˆë²½ ğŸŒ…</option>
                    <option value="morning">ì•„ì¹¨ â˜€ï¸</option>
                    <option value="afternoon">ì˜¤í›„ ğŸŒ¤ï¸</option>
                    <option value="evening">ì €ë… ğŸŒ†</option>
                    <option value="night">ë°¤ ğŸŒ™</option>
                </select>
                <select id="listenPlace" class="bg-black border-2 border-[#222] p-3 text-sm focus:border-white outline-none font-pixel">
                    <option value="">ì¥ì†Œ</option>
                    <option value="home">ì§‘ ğŸ </option>
                    <option value="work">ì§ì¥ ğŸ¢</option>
                    <option value="transport">ì´ë™ì¤‘ ğŸš—</option>
                    <option value="outdoor">ì•¼ì™¸ ğŸŒ³</option>
                    <option value="cafe">ì¹´í˜ â˜•</option>
                    <option value="other">ê¸°íƒ€</option>
                </select>
                <select id="listenMood" class="bg-black border-2 border-[#222] p-3 text-sm focus:border-white outline-none font-pixel">
                    <option value="">ê¸°ë¶„</option>
                    <option value="good">ì¢‹ìŒ ğŸ˜Š</option>
                    <option value="tired">í”¼ê³¤ ğŸ˜´</option>
                    <option value="stressed">ìŠ¤íŠ¸ë ˆìŠ¤ ğŸ˜°</option>
                    <option value="lonely">ì™¸ë¡œì›€ ğŸ˜¢</option>
                    <option value="excited">ì„¤ë ˜ ğŸ¤—</option>
                    <option value="peaceful">í‰ì˜¨ ğŸ˜Œ</option>
                </select>
                <input type="text" id="listenWith" placeholder="ëˆ„êµ¬ì™€ í•¨ê»˜?" class="bg-black border-2 border-[#222] p-3 text-sm focus:border-white outline-none font-pixel" maxlength="50">
            </div>
        </div>

        <!-- ê°œì¸ ì •ë³´ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <input
                type="text"
                id="commentAuthor"
                maxlength="50"
                placeholder="ë‹‰ë„¤ì„ (ì„ íƒì‚¬í•­)"
                class="bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-pixel"
            >
            <input
                type="text"
                id="emotionTags"
                maxlength="100"
                placeholder="ê°ì • íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„: ì‚¬ë‘, ì¶”ì–µ, í¬ë§...)"
                class="bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-pixel"
            >
        </div>

        <!-- ê°ì • ì¼ê¸° -->
        <div class="mb-6">
            <label class="text-[10px] uppercase tracking-widest opacity-50 mb-4 block">ê°ì • ì¼ê¸°</label>
            <textarea
                id="commentContent"
                maxlength="5000"
                placeholder="ì´ ê³¡ì„ ë“¤ìœ¼ë©° ì–´ë–¤ ê°ì •ì´ ë“¤ì—ˆë‚˜ìš”? ë– ì˜¤ë¥´ëŠ” ì¶”ì–µì´ë‚˜ ìƒê°ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”. ì´ ê³¡ì´ ë‹¹ì‹ ì˜ í•˜ë£¨ë¥¼ ì–´ë–»ê²Œ ë¬¼ë“¤ì˜€ëŠ”ì§€, ì–´ë–¤ ê¸°ë¶„ìœ¼ë¡œ ë“¤ì—ˆëŠ”ì§€, ì–´ë–¤ ìƒê°ì´ ë“¤ì—ˆëŠ”ì§€... ëª¨ë‘ ê¸°ë¡í•´ë³´ì„¸ìš”."
                class="w-full bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-serif min-h-48 resize-vertical"
            ></textarea>
            <div class="text-[10px] mt-2 opacity-40 uppercase tracking-widest text-right">
                <span id="commentCount">0</span> / 5000
            </div>
        </div>

        <div class="flex justify-end mt-6">
            <button class="btn-pixel text-xs tracking-widest" id="commentSubmitBtn" onclick="submitComment()">SAVE_EMOTION_DIARY</button>
        </div>
        <div id="commentMsg" class="text-xs mt-4 opacity-70"></div>
    </section>

    <section class="space-y-6">
        <div class="flex items-end justify-between">
            <h3 class="text-xs uppercase tracking-[0.3em] opacity-40">Comments</h3>
            <div class="text-[10px] opacity-40 uppercase tracking-widest">{{ comments|length }} items</div>
        </div>

        {% if comments %}
            {% for c in comments %}
                <article class="pixel-card p-6">
                    <div class="flex justify-between items-start gap-4">
                        <div class="text-[10px] uppercase tracking-widest opacity-40">
                            {{ c.author }} Â· {{ c.created_at[:10] if c.created_at else '' }}
                        </div>
                        <button class="btn-outline text-[10px] tracking-widest" onclick="openDeleteModal('{{ c.id }}')">DELETE</button>
                    </div>
                    <div class="mt-4 text-base serif-font leading-relaxed whitespace-pre-wrap">
                        {{ c.content }}
                    </div>
                </article>
            {% endfor %}
        {% else %}
            <div class="pixel-card p-10 text-center">
                <h3 class="text-xl serif-font mb-2">ì•„ì§ ì½”ë©˜íŠ¸ê°€ ì—†ì–´ìš”</h3>
                <p class="text-sm opacity-50 italic serif-font">ì²« ë²ˆì§¸ ê°ìƒì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<!-- ì‚­ì œ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden">
    <div class="pixel-card p-6 md:p-8 max-w-sm w-full mx-4">
        <h3 class="text-sm uppercase tracking-[0.3em] mb-6">ê´€ë¦¬ì ì¸ì¦</h3>
        <input
            type="password"
            id="deletePasswordInput"
            placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
            class="w-full bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-pixel mb-4"
        >
        <div id="deleteModalError" class="text-xs text-red-400 mb-4 hidden"></div>
        <div class="flex gap-3">
            <button class="btn-outline text-xs tracking-widest flex-1" onclick="closeDeleteModal()">CANCEL</button>
            <button class="btn-pixel text-xs tracking-widest flex-1" id="deleteConfirmBtn" onclick="confirmDelete()">DELETE</button>
        </div>
    </div>
</div>

<script>
let pendingDeleteCommentId = null;

function openDeleteModal(commentId) {
    pendingDeleteCommentId = commentId;
    document.getElementById('deletePasswordInput').value = '';
    document.getElementById('deleteModalError').classList.add('hidden');
    document.getElementById('deleteModal').classList.remove('hidden');
    document.getElementById('deletePasswordInput').focus();
}

function closeDeleteModal() {
    pendingDeleteCommentId = null;
    document.getElementById('deleteModal').classList.add('hidden');
}

async function confirmDelete() {
    const pw = document.getElementById('deletePasswordInput').value.trim();
    const errorEl = document.getElementById('deleteModalError');
    const btn = document.getElementById('deleteConfirmBtn');
    
    if (!pw) {
        errorEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        errorEl.classList.remove('hidden');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'DELETING...';
    errorEl.classList.add('hidden');
    
    try {
        const res = await fetch(`/api/track_comments/${pendingDeleteCommentId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password: pw})
        });
        const data = await res.json();
        if (data.success) {
            closeDeleteModal();
            window.location.reload();
            return;
        }
        errorEl.textContent = data.error || 'ì‚­ì œ ì‹¤íŒ¨';
        errorEl.classList.remove('hidden');
    } catch (e) {
        errorEl.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.';
        errorEl.classList.remove('hidden');
    } finally {
        btn.disabled = false;
        btn.textContent = 'DELETE';
    }
}

// Enter í‚¤ë¡œ ì‚­ì œ í™•ì¸
document.getElementById('deletePasswordInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') confirmDelete();
    if (e.key === 'Escape') closeDeleteModal();
});

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('deleteModal').addEventListener('click', (e) => {
    if (e.target.id === 'deleteModal') closeDeleteModal();
});

function renderAddedAtLocal() {
    const el = document.getElementById('addedAtLocal');
    if (!el) return;
    const iso = (el.getAttribute('data-iso') || '').trim();
    if (!iso) return;
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return;
    el.textContent = d.toLocaleString();
}

function activateYouTube() {
    const player = document.getElementById('youtubePlayer');
    const iframe = document.getElementById('ytIframe');
    
    console.log('[Player] activateYouTube called');
    
    if (player && iframe) {
        player.classList.remove('hidden');
        iframe.src = "https://www.youtube.com/embed/{{ embed.source_id }}?autoplay=1";
        console.log('[Player] YouTube iframe src set');
    } else {
        console.log('[Player] YouTube elements not found');
    }
}

// ê°ì • ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
document.querySelectorAll('.emotion-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('bg-white/10', 'border-white'));
        this.classList.add('bg-white/10', 'border-white');
        document.getElementById('selectedEmotion').value = this.dataset.emotion;
    });
});

// ê°ì • ê°•ë„ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
document.querySelectorAll('.intensity-btn').forEach((btn, index) => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.intensity-btn').forEach(b => b.classList.remove('bg-white/20'));
        this.classList.add('bg-white/20');
        document.querySelector(`#int${index + 1}`).checked = true;
    });
});

const contentEl = document.getElementById('commentContent');
const countEl = document.getElementById('commentCount');
contentEl.addEventListener('input', () => { countEl.textContent = (contentEl.value || '').length; });
renderAddedAtLocal();

async function submitComment() {
    const btn = document.getElementById('commentSubmitBtn');
    const msg = document.getElementById('commentMsg');

    // ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘
    const author = (document.getElementById('commentAuthor').value || '').trim() || 'Anonymous';
    const content = (document.getElementById('commentContent').value || '').trim();
    const emotion = document.getElementById('selectedEmotion').value;
    const intensity = document.querySelector('input[name="intensity"]:checked')?.value || '3';
    const emotionTags = (document.getElementById('emotionTags').value || '').trim();

    // ì²­ì·¨ í™˜ê²½ ìˆ˜ì§‘
    const listenTime = document.getElementById('listenTime').value;
    const listenPlace = document.getElementById('listenPlace').value;
    const listenMood = document.getElementById('listenMood').value;
    const listenWith = (document.getElementById('listenWith').value || '').trim();

    if (!content) {
        msg.textContent = 'ê°ì • ì¼ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.';
        return;
    }

    // ê°ì • ë°ì´í„°ë¥¼ í¬í•¨í•œ ì½˜í…ì¸  ìƒì„±
    let enhancedContent = content;

    // ê°ì • ì •ë³´ ì¶”ê°€
    if (emotion) {
        const emotionMap = {
            'happy': 'ğŸ˜Š í–‰ë³µí•œ',
            'sad': 'ğŸ˜¢ ìŠ¬í”ˆ',
            'excited': 'ğŸ¤© ì„¤ë ˆëŠ”',
            'calm': 'ğŸ˜Œ í‰ì˜¨í•œ',
            'angry': 'ğŸ˜  í™”ë‚˜ëŠ”',
            'nostalgic': 'ğŸ¥º ê·¸ë¦¬ìš´'
        };
        enhancedContent = `[ê°ì •: ${emotionMap[emotion]} (ê°•ë„: ${intensity}/5)]\n\n${enhancedContent}`;
    }

    // ì²­ì·¨ í™˜ê²½ ì •ë³´ ì¶”ê°€
    const envInfo = [];
    if (listenTime) envInfo.push(`ì‹œê°„: ${listenTime}`);
    if (listenPlace) envInfo.push(`ì¥ì†Œ: ${listenPlace}`);
    if (listenMood) envInfo.push(`ê¸°ë¶„: ${listenMood}`);
    if (listenWith) envInfo.push(`í•¨ê»˜: ${listenWith}`);

    if (envInfo.length > 0) {
        enhancedContent += `\n\n[ì²­ì·¨ í™˜ê²½]\n${envInfo.join(' | ')}`;
    }

    // íƒœê·¸ ì •ë³´ ì¶”ê°€
    if (emotionTags) {
        enhancedContent += `\n\n[ê°ì • íƒœê·¸]\n${emotionTags}`;
    }

    btn.disabled = true;
    btn.textContent = 'SAVING_EMOTION...';
    msg.textContent = '';

    try {
        const res = await fetch('/api/tracks/{{ track.id }}/comments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                author,
                content: enhancedContent,
                emotion_data: {
                    emotion,
                    intensity: parseInt(intensity),
                    listen_time: listenTime,
                    listen_place: listenPlace,
                    listen_mood: listenMood,
                    listen_with: listenWith,
                    emotion_tags: emotionTags
                }
            })
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
            return;
        }
        msg.textContent = data.error || 'ì €ì¥ ì‹¤íŒ¨';
    } catch (e) {
        msg.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'SAVE_EMOTION_DIARY';
    }
}

</script>
{% endblock %}

