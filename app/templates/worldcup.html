{% extends "base.html" %}

{% block title %}ì´ìƒí˜• ì›”ë“œì»µ - OFF THE COMMUNITY{% endblock %}

{% block extra_css %}
<style>
    .worldcup-container {
        max-width: 1400px;
        margin: 0 auto;
        height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .worldcup-header {
        text-align: center;
        margin-bottom: 2rem;
        flex-shrink: 0;
    }
    
    .battle-section {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 3rem;
        align-items: center;
        flex: 1;
        min-height: 0;
        padding: 0 2rem;
    }
    
    @media (max-width: 768px) {
        .battle-section {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr auto 1fr;
            gap: 1.5rem;
        }
        
        .vs-divider {
            order: 2;
        }
    }
    
    .track-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        height: 100%;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }
    
    .track-card:hover {
        border-color: var(--pixel-white);
        transform: scale(1.02);
    }
    
    .track-card.selected {
        border-color: var(--pixel-white);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }
    
    .track-cover {
        width: 100%;
        flex: 1;
        min-height: 0;
        background: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .track-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .track-info {
        flex-shrink: 0;
    }
    
    .vs-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: bold;
        opacity: 0.3;
        flex-shrink: 0;
    }
    
    @media (max-width: 768px) {
        .vs-divider {
            font-size: 2rem;
        }
    }
    
    .loading-state {
        text-align: center;
        padding: 4rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    .stats-section {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content-container worldcup-container">
    <div class="worldcup-header">
        <div class="inline-flex items-center gap-4 mb-6">
            <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">System Node: WorldCup</span>
            <div class="w-12 h-[1px] bg-white/20"></div>
        </div>
        <h2 class="serif-font text-4xl md:text-5xl mb-4">SONG WORLD CUP_</h2>
        <p class="text-sm opacity-50">ëª¨ë“  ì‚¬ìš©ìê°€ ì¶”ê°€í•œ ê³¡ ì¤‘ì—ì„œ ì„ í˜¸í•˜ëŠ” ê³¡ì„ ì„ íƒí•˜ì„¸ìš”</p>
    </div>
    
    <div id="battleContainer" class="battle-section">
        <div class="loading-state">
            <p class="text-lg opacity-50">ë¡œë”© ì¤‘...</p>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTracks = [];
let selectedTrackId = null;
let seenTrackIds = []; // ì´ë¯¸ ë“±ì¥í•œ ê³¡ ID ëª©ë¡

async function loadBattle() {
    const container = document.getElementById('battleContainer');
    container.innerHTML = '<div class="loading-state"><p class="text-lg opacity-50">ë¡œë”© ì¤‘...</p></div>';
    
    try {
        // ì´ë¯¸ ë³¸ ê³¡ë“¤ì„ ì œì™¸í•˜ê³  ìš”ì²­
        const excludeIds = seenTrackIds.length > 0 ? seenTrackIds.join(',') : '';
        const url = excludeIds ? `/api/worldcup/tracks?exclude=${excludeIds}` : '/api/worldcup/tracks';
        
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success && data.tracks && data.tracks.length === 2) {
            currentTracks = data.tracks;
            selectedTrackId = null;
            
            // ë“±ì¥í•œ ê³¡ë“¤ì„ seenTrackIdsì— ì¶”ê°€
            data.tracks.forEach(track => {
                if (!seenTrackIds.includes(track.id)) {
                    seenTrackIds.push(track.id);
                }
            });
            
            renderBattle(data.tracks);
        } else if (data.error && data.error.includes('ë¶€ì¡±')) {
            // ëª¨ë“  ê³¡ì„ ë‹¤ ë³¸ ê²½ìš°
            container.innerHTML = `
                <div class="pixel-card p-10 text-center">
                    <h3 class="text-xl serif-font mb-2">ëª¨ë“  ê³¡ì„ ë‹¤ ë´¤ìŠµë‹ˆë‹¤!</h3>
                    <p class="text-sm opacity-50 mb-4">ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                    <button class="btn-pixel text-xs tracking-widest" onclick="resetWorldCup()">ë‹¤ì‹œ ì‹œì‘</button>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="pixel-card p-10 text-center">
                    <h3 class="text-xl serif-font mb-2">ê³¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤</h3>
                    <p class="text-sm opacity-50">ë°ì´í„°ë² ì´ìŠ¤ì— ìµœì†Œ 2ê°œ ì´ìƒì˜ ê³¡ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                </div>
            `;
        }
    } catch (e) {
        console.error('ë°°í‹€ ë¡œë“œ ì‹¤íŒ¨:', e);
        container.innerHTML = '<div class="pixel-card p-10 text-center"><p class="text-red-400">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p></div>';
    }
}

function resetWorldCup() {
    seenTrackIds = [];
    loadBattle();
}

function renderBattle(tracks) {
    const container = document.getElementById('battleContainer');
    const [trackA, trackB] = tracks;
    
    container.innerHTML = `
        <div class="track-card pixel-card p-6" 
             data-track-id="${trackA.id}"
             onclick="selectTrack('${trackA.id}')">
            <div class="track-cover">
                ${trackA.thumbnail_url ? 
                    `<img src="${trackA.thumbnail_url}" alt="${trackA.title}">` : 
                    '<span class="text-4xl opacity-20">ğŸµ</span>'
                }
            </div>
            <div class="track-info">
                <h3 class="text-xl serif-font mb-2 truncate">${trackA.title}</h3>
                <p class="text-sm opacity-50 mb-2 truncate">${trackA.artist || 'Unknown'}</p>
                <p class="text-[10px] opacity-30">${trackA.duration_str || ''}</p>
            </div>
        </div>
        
        <div class="vs-divider">VS</div>
        
        <div class="track-card pixel-card p-6" 
             data-track-id="${trackB.id}"
             onclick="selectTrack('${trackB.id}')">
            <div class="track-cover">
                ${trackB.thumbnail_url ? 
                    `<img src="${trackB.thumbnail_url}" alt="${trackB.title}">` : 
                    '<span class="text-4xl opacity-20">ğŸµ</span>'
                }
            </div>
            <div class="track-info">
                <h3 class="text-xl serif-font mb-2 truncate">${trackB.title}</h3>
                <p class="text-sm opacity-50 mb-2 truncate">${trackB.artist || 'Unknown'}</p>
                <p class="text-[10px] opacity-30">${trackB.duration_str || ''}</p>
            </div>
        </div>
    `;
}

async function selectTrack(trackId) {
    if (selectedTrackId) return; // ì´ë¯¸ ì„ íƒë¨
    
    selectedTrackId = trackId;
    
    // ì„ íƒëœ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
    document.querySelectorAll('.track-card').forEach(card => {
        if (card.dataset.trackId === trackId) {
            card.classList.add('selected');
        } else {
            card.style.opacity = '0.5';
        }
    });
    
    // íˆ¬í‘œ ì €ì¥
    const trackA = currentTracks[0];
    const trackB = currentTracks[1];
    
    try {
        const res = await fetch('/api/worldcup/vote', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                track_a_id: trackA.id,
                track_b_id: trackB.id,
                winner_id: trackId
            })
        });
        
        const data = await res.json();
        if (data.success) {
            // 1ì´ˆ í›„ ë‹¤ìŒ ë°°í‹€ ë¡œë“œ
            setTimeout(() => {
                loadBattle();
            }, 1000);
        } else {
            alert(data.error || 'íˆ¬í‘œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            selectedTrackId = null;
            document.querySelectorAll('.track-card').forEach(card => {
                card.classList.remove('selected');
                card.style.opacity = '1';
            });
        }
    } catch (e) {
        console.error('íˆ¬í‘œ ì €ì¥ ì‹¤íŒ¨:', e);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        selectedTrackId = null;
        document.querySelectorAll('.track-card').forEach(card => {
            card.classList.remove('selected');
            card.style.opacity = '1';
        });
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë°°í‹€ ë¡œë“œ
document.addEventListener('DOMContentLoaded', () => {
    loadBattle();
});
</script>
{% endblock %}
