{% extends "base.html" %}

{% block title %}ì´ìƒí˜• ì›”ë“œì»µ - OFF THE COMMUNITY{% endblock %}

{% block extra_css %}
<style>
    .worldcup-container {
        max-width: 1400px;
        margin: 0 auto;
        min-height: calc(100vh - 120px);
        display: flex;
        flex-direction: column;
    }
    
    .worldcup-header {
        text-align: center;
        margin-bottom: 2rem;
        flex-shrink: 0;
    }
    
    .battle-section {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 3rem;
        align-items: center;
        flex: 1;
        min-height: 0;
        padding: 0 2rem;
    }
    
    @media (max-width: 768px) {
        .battle-section {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr auto 1fr;
            gap: 1.5rem;
        }
        
        .vs-divider {
            order: 2;
        }
    }
    
    .track-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        height: 100%;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }
    
    .track-card:hover {
        border-color: var(--pixel-white);
        transform: scale(1.02);
    }
    
    .track-card.selected {
        border-color: var(--pixel-white);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }
    
    .track-cover {
        width: 100%;
        flex: 1;
        min-height: 0;
        background: #111;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    
    .track-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .track-info {
        flex-shrink: 0;
    }
    
    .vs-divider {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: bold;
        opacity: 0.3;
        flex-shrink: 0;
    }
    
    @media (max-width: 768px) {
        .vs-divider {
            font-size: 2rem;
        }
    }
    
    .loading-state {
        text-align: center;
        padding: 4rem 0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    .stats-section {
        display: none;
    }
    
    .results-section {
        display: none !important;
        width: 100%;
        position: relative;
    }
    
    .results-section.active {
        display: block !important;
    }
    
    .battle-section.hidden {
        display: none !important;
    }
    
    .results-header {
        text-align: center;
        margin-bottom: 3rem;
        padding: 2rem 0;
    }
    
    .rankings-list {
        display: grid;
        gap: 1.5rem;
        max-width: 900px;
        margin: 0 auto;
    }
    
    .ranking-item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 1.5rem;
        align-items: center;
        padding: 1.5rem;
        border: 2px solid rgba(255, 255, 255, 0.1);
        background: rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
    }
    
    .ranking-item:hover {
        border-color: rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.5);
    }
    
    .ranking-item.top-3 {
        border-color: rgba(255, 215, 0, 0.5);
        background: rgba(255, 215, 0, 0.1);
    }
    
    .rank-number {
        font-size: 2rem;
        font-weight: bold;
        min-width: 60px;
        text-align: center;
        font-family: var(--font-mono);
    }
    
    .rank-number.top-1 {
        color: #FFD700;
    }
    
    .rank-number.top-2 {
        color: #C0C0C0;
    }
    
    .rank-number.top-3 {
        color: #CD7F32;
    }
    
    .ranking-track-info {
        flex: 1;
    }
    
    .ranking-track-title {
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        font-family: var(--font-serif);
    }
    
    .ranking-track-artist {
        font-size: 0.9rem;
        opacity: 0.7;
        margin-bottom: 0.25rem;
    }
    
    .ranking-track-stats {
        font-size: 0.75rem;
        opacity: 0.5;
        font-family: var(--font-mono);
    }
    
    .ranking-wins {
        text-align: right;
        font-size: 1.5rem;
        font-weight: bold;
        font-family: var(--font-mono);
    }
    
    .ranking-wins-label {
        font-size: 0.75rem;
        opacity: 0.5;
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }
    
    .ranking-cover {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    @media (max-width: 768px) {
        .ranking-item {
            grid-template-columns: auto 1fr;
            gap: 1rem;
        }
        
        .ranking-wins {
            grid-column: 1 / -1;
            text-align: left;
            margin-top: 0.5rem;
        }
        
        .rank-number {
            font-size: 1.5rem;
            min-width: 40px;
        }
        
        .ranking-cover {
            width: 60px;
            height: 60px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content-container worldcup-container">
    <header class="community-header mb-12">
        <div class="inline-flex items-center gap-4 mb-6">
            <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">System Node: WorldCup</span>
            <div class="w-12 h-[1px] bg-white/20"></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h2 class="serif-font text-4xl md:text-5xl mb-3">SONG WORLD CUP_</h2>
                <p class="text-[11px] uppercase tracking-widest opacity-50">
                    Track Battle System
                </p>
            </div>
            <button class="btn-outline text-xs tracking-widest" onclick="showResults()" id="showResultsBtn">
                ê²°ê³¼ ë³´ê¸°
            </button>
        </div>
    </header>
    
    <div id="battleContainer" class="battle-section">
        <div class="loading-state">
            <p class="text-lg opacity-50">ë¡œë”© ì¤‘...</p>
        </div>
    </div>
    
    <div id="resultsSection" class="results-section">
        <div class="results-header">
            <div class="inline-flex items-center gap-4 mb-6">
                <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">System Node: Results</span>
                <div class="w-12 h-[1px] bg-white/20"></div>
            </div>
            <h2 class="serif-font text-4xl md:text-5xl mb-3">ğŸ† íˆ¬í‘œ ê²°ê³¼</h2>
            <p class="text-[11px] uppercase tracking-widest opacity-50 mb-6">
                Rankings by Win Count
            </p>
            <button class="btn-outline text-xs tracking-widest" onclick="hideResults()">â† íˆ¬í‘œë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
        <div id="rankingsList" class="rankings-list">
            <div class="loading-state">
                <p class="text-lg opacity-50">ê²°ê³¼ ë¡œë”© ì¤‘...</p>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTracks = [];
let selectedTrackId = null;
let seenTrackIds = []; // ì´ë¯¸ ë“±ì¥í•œ ê³¡ ID ëª©ë¡

async function loadBattle() {
    const container = document.getElementById('battleContainer');
    const resultsSection = document.getElementById('resultsSection');
    const showResultsBtn = document.getElementById('showResultsBtn');
    
    // ê²°ê³¼ ì„¹ì…˜ ì™„ì „íˆ ìˆ¨ê¸°ê¸°
    if (resultsSection) {
        resultsSection.style.display = 'none';
        resultsSection.classList.remove('active');
    }
    
    // ë°°í‹€ ì„¹ì…˜ í‘œì‹œ
    if (container) {
        container.style.display = 'grid';
        container.classList.remove('hidden');
        container.innerHTML = '<div class="loading-state"><p class="text-lg opacity-50">ë¡œë”© ì¤‘...</p></div>';
    }
    
    // ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
    if (showResultsBtn) {
        showResultsBtn.style.display = 'block';
    }
    
    try {
        // ì´ë¯¸ ë³¸ ê³¡ë“¤ì„ ì œì™¸í•˜ê³  ìš”ì²­
        const excludeIds = seenTrackIds.length > 0 ? seenTrackIds.join(',') : '';
        const url = excludeIds ? `/api/worldcup/tracks?exclude=${excludeIds}` : '/api/worldcup/tracks';
        
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.success && data.tracks && data.tracks.length === 2) {
            currentTracks = data.tracks;
            selectedTrackId = null;
            
            // ë“±ì¥í•œ ê³¡ë“¤ì„ seenTrackIdsì— ì¶”ê°€
            data.tracks.forEach(track => {
                if (!seenTrackIds.includes(track.id)) {
                    seenTrackIds.push(track.id);
                }
            });
            
            renderBattle(data.tracks);
        } else if (data.error && data.error.includes('ë¶€ì¡±')) {
            // ëª¨ë“  ê³¡ì„ ë‹¤ ë³¸ ê²½ìš°
            container.innerHTML = `
                <div class="pixel-card p-10 text-center">
                    <h3 class="text-xl serif-font mb-2">ëª¨ë“  ê³¡ì„ ë‹¤ ë´¤ìŠµë‹ˆë‹¤!</h3>
                    <p class="text-sm opacity-50 mb-4">íˆ¬í‘œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                    <button class="btn-pixel text-xs tracking-widest mr-2" onclick="showResults()">ê²°ê³¼ ë³´ê¸°</button>
                    <button class="btn-outline text-xs tracking-widest" onclick="resetWorldCup()">ë‹¤ì‹œ ì‹œì‘</button>
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="pixel-card p-10 text-center">
                    <h3 class="text-xl serif-font mb-2">ê³¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤</h3>
                    <p class="text-sm opacity-50">ë°ì´í„°ë² ì´ìŠ¤ì— ìµœì†Œ 2ê°œ ì´ìƒì˜ ê³¡ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                </div>
            `;
        }
    } catch (e) {
        console.error('ë°°í‹€ ë¡œë“œ ì‹¤íŒ¨:', e);
        container.innerHTML = '<div class="pixel-card p-10 text-center"><p class="text-red-400">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p></div>';
    }
}

function resetWorldCup() {
    seenTrackIds = [];
    loadBattle();
}

function renderBattle(tracks) {
    const container = document.getElementById('battleContainer');
    const [trackA, trackB] = tracks;
    
    container.innerHTML = `
        <div class="track-card pixel-card p-6" 
             data-track-id="${trackA.id}"
             onclick="selectTrack('${trackA.id}')">
            <div class="track-cover">
                ${trackA.thumbnail_url ? 
                    `<img src="${trackA.thumbnail_url}" alt="${trackA.title}">` : 
                    '<span class="text-4xl opacity-20">ğŸµ</span>'
                }
            </div>
            <div class="track-info">
                <h3 class="text-xl serif-font mb-2 truncate">${trackA.title}</h3>
                <p class="text-sm opacity-50 mb-2 truncate">${trackA.artist || 'Unknown'}</p>
                <p class="text-[10px] opacity-30">${trackA.duration_str || ''}</p>
            </div>
        </div>
        
        <div class="vs-divider">VS</div>
        
        <div class="track-card pixel-card p-6" 
             data-track-id="${trackB.id}"
             onclick="selectTrack('${trackB.id}')">
            <div class="track-cover">
                ${trackB.thumbnail_url ? 
                    `<img src="${trackB.thumbnail_url}" alt="${trackB.title}">` : 
                    '<span class="text-4xl opacity-20">ğŸµ</span>'
                }
            </div>
            <div class="track-info">
                <h3 class="text-xl serif-font mb-2 truncate">${trackB.title}</h3>
                <p class="text-sm opacity-50 mb-2 truncate">${trackB.artist || 'Unknown'}</p>
                <p class="text-[10px] opacity-30">${trackB.duration_str || ''}</p>
            </div>
        </div>
    `;
}

async function selectTrack(trackId) {
    if (selectedTrackId) return; // ì´ë¯¸ ì„ íƒë¨
    
    selectedTrackId = trackId;
    
    // ì„ íƒëœ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
    document.querySelectorAll('.track-card').forEach(card => {
        if (card.dataset.trackId === trackId) {
            card.classList.add('selected');
        } else {
            card.style.opacity = '0.5';
        }
    });
    
    // íˆ¬í‘œ ì €ì¥
    const trackA = currentTracks[0];
    const trackB = currentTracks[1];
    
    try {
        const res = await fetch('/api/worldcup/vote', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                track_a_id: trackA.id,
                track_b_id: trackB.id,
                winner_id: trackId
            })
        });
        
        const data = await res.json();
        if (data.success) {
            // 1ì´ˆ í›„ ë‹¤ìŒ ë°°í‹€ ë¡œë“œ
            setTimeout(() => {
                loadBattle();
            }, 1000);
        } else {
            alert(data.error || 'íˆ¬í‘œ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            selectedTrackId = null;
            document.querySelectorAll('.track-card').forEach(card => {
                card.classList.remove('selected');
                card.style.opacity = '1';
            });
        }
    } catch (e) {
        console.error('íˆ¬í‘œ ì €ì¥ ì‹¤íŒ¨:', e);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        selectedTrackId = null;
        document.querySelectorAll('.track-card').forEach(card => {
            card.classList.remove('selected');
            card.style.opacity = '1';
        });
    }
}

async function showResults() {
    const battleContainer = document.getElementById('battleContainer');
    const resultsSection = document.getElementById('resultsSection');
    const rankingsList = document.getElementById('rankingsList');
    const showResultsBtn = document.getElementById('showResultsBtn');
    
    // ë°°í‹€ ì„¹ì…˜ ì™„ì „íˆ ìˆ¨ê¸°ê¸°
    if (battleContainer) {
        battleContainer.style.display = 'none';
        battleContainer.classList.add('hidden');
    }
    
    // ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    if (showResultsBtn) {
        showResultsBtn.style.display = 'none';
    }
    
    // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
    if (resultsSection) {
        resultsSection.style.display = 'block';
        resultsSection.classList.add('active');
    }
    
    if (rankingsList) {
        rankingsList.innerHTML = '<div class="loading-state"><p class="text-lg opacity-50">ê²°ê³¼ ë¡œë”© ì¤‘...</p></div>';
    }
    
    try {
        const res = await fetch('/api/worldcup/results?limit=50');
        const data = await res.json();
        
        if (data.success && data.rankings && data.rankings.length > 0) {
            let html = '';
            data.rankings.forEach((ranking, index) => {
                const isTop3 = ranking.rank <= 3;
                const rankClass = ranking.rank === 1 ? 'top-1' : ranking.rank === 2 ? 'top-2' : ranking.rank === 3 ? 'top-3' : '';
                const coverUrl = ranking.cover_url || '/static/img/default-cover.png';
                
                html += `
                    <div class="pixel-card ranking-item ${isTop3 ? 'top-3' : ''}">
                        <div class="rank-number ${rankClass}">${ranking.rank}</div>
                        <div class="ranking-track-info">
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <img src="${coverUrl}" alt="${ranking.title}" class="ranking-cover" onerror="this.src='/static/img/default-cover.png'">
                                <div>
                                    <div class="ranking-track-title">${ranking.title || 'Unknown'}</div>
                                    <div class="ranking-track-artist">${ranking.artist || 'Unknown Artist'}</div>
                                    <div class="ranking-track-stats">${ranking.duration_str || ''}</div>
                                </div>
                            </div>
                        </div>
                        <div class="ranking-wins">
                            ${ranking.wins}
                            <div class="ranking-wins-label">WINS</div>
                        </div>
                    </div>
                `;
            });
            
            rankingsList.innerHTML = html;
        } else {
            rankingsList.innerHTML = `
                <div class="pixel-card p-10 text-center">
                    <h3 class="text-xl serif-font mb-2">ì•„ì§ íˆ¬í‘œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p class="text-sm opacity-50 mb-4">íˆ¬í‘œë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                    <button class="btn-pixel text-xs tracking-widest" onclick="hideResults()">íˆ¬í‘œ ì‹œì‘</button>
                </div>
            `;
        }
    } catch (e) {
        console.error('ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', e);
        rankingsList.innerHTML = '<div class="pixel-card p-10 text-center"><p class="text-red-400">ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
    }
}

function hideResults() {
    const battleContainer = document.getElementById('battleContainer');
    const resultsSection = document.getElementById('resultsSection');
    const showResultsBtn = document.getElementById('showResultsBtn');
    
    // ê²°ê³¼ ì„¹ì…˜ ì™„ì „íˆ ìˆ¨ê¸°ê¸°
    if (resultsSection) {
        resultsSection.style.display = 'none';
        resultsSection.classList.remove('active');
    }
    
    // ë°°í‹€ ì„¹ì…˜ í‘œì‹œ
    if (battleContainer) {
        battleContainer.style.display = 'grid';
        battleContainer.classList.remove('hidden');
    }
    
    // ê²°ê³¼ ë³´ê¸° ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
    if (showResultsBtn) {
        showResultsBtn.style.display = 'block';
    }
    
    resetWorldCup();
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì²« ë°°í‹€ ë¡œë“œ
document.addEventListener('DOMContentLoaded', () => {
    // ê²°ê³¼ ì„¹ì…˜ ì´ˆê¸°í™” - ì™„ì „íˆ ìˆ¨ê¸°ê¸°
    const resultsSection = document.getElementById('resultsSection');
    if (resultsSection) {
        resultsSection.style.display = 'none';
        resultsSection.classList.remove('active');
    }
    
    // ë°°í‹€ ì„¹ì…˜ í‘œì‹œ
    const battleContainer = document.getElementById('battleContainer');
    if (battleContainer) {
        battleContainer.style.display = 'grid';
        battleContainer.classList.remove('hidden');
    }
    
    loadBattle();
});
</script>
{% endblock %}




