{% extends "base.html" %}

{% block title %}í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ - OFF THE COMMUNITY{% endblock %}

{% block content %}
<div class="main-content-container">
    <header class="community-header mb-12">
        <div class="flex items-center justify-between mb-6">
            <div class="inline-flex items-center gap-4">
                <span class="text-[10px] tracking-[0.4em] uppercase opacity-40">System Node: Playlists</span>
                <div class="w-12 h-[1px] bg-white/20"></div>
            </div>
            <button class="btn-outline text-[10px] tracking-widest" id="globalEditBtn" onclick="toggleGlobalEditMode()">EDIT</button>
        </div>
        <h2 class="serif-font text-4xl md:text-5xl mb-3">SONG ARCHIVE_</h2>
        <p class="text-[11px] uppercase tracking-widest opacity-50">
            Playlist Management
        </p>
    </header>

    {% if error %}
        <div class="pixel-card p-6 border border-red-500/40 text-red-200 text-sm mb-10">
            {{ error }}
        </div>
    {% endif %}

    <!-- URL ì¶”ê°€ ì„¹ì…˜ -->
    <section class="pixel-card p-6 md:p-10 mb-10">
        <h3 class="text-xs uppercase tracking-[0.3em] opacity-40 mb-6">Add a Track URL</h3>
        <div class="flex flex-col md:flex-row gap-4">
            <input
                type="url"
                id="trackUrl"
                placeholder="https://soundcloud.com/...  ë˜ëŠ”  https://www.youtube.com/watch?v=..."
                class="flex-1 bg-black border-2 border-[#222] p-4 text-sm focus:border-white outline-none font-pixel"
            >
            <button class="btn-pixel md:px-8 text-xs tracking-widest" id="addTrackBtn" onclick="addTrack()">ADD_TRACK</button>
        </div>
        <p class="text-[10px] mt-4 opacity-30 uppercase tracking-widest">Supported: SoundCloud / YouTube</p>
        <div id="addTrackMsg" class="text-xs mt-4 opacity-70"></div>
    </section>

    <!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒì„± ì„¹ì…˜ -->
    <section class="pixel-card p-6 md:p-10 mb-10">
        <div class="flex justify-center">
            <button class="btn-pixel text-xs tracking-widest px-8 py-4" id="createPlaylistBtn" onclick="createPlaylist()">+ CREATE NEW PLAYLIST</button>
        </div>
        <div id="createPlaylistMsg" class="text-xs mt-4 opacity-70 text-center"></div>
    </section>

    <!-- í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì†í•˜ì§€ ì•Šì€ ê³¡ë“¤ -->
    {% if unassigned_tracks %}
        <section class="mb-10">
            <h3 class="text-xs uppercase tracking-[0.3em] opacity-40 mb-6">Unassigned Tracks</h3>
            <div class="space-y-4" id="unassignedTracksList">
                {% for track in unassigned_tracks %}
                    <article class="pixel-card p-4 hover:border-white/40 transition-all track-item" 
                             data-track-id="{{ track.id }}">
                        <div class="flex gap-4 items-center">
                            <div class="w-12 h-12 bg-white/5 border border-white/10 flex items-center justify-center overflow-hidden cursor-pointer"
                                 onclick="window.location.href='{{ url_for('track_detail', track_id=track.id) }}'">
                                {% if track.thumbnail_url %}
                                    <img src="{{ track.thumbnail_url }}" alt="cover" class="w-full h-full object-cover">
                                {% else %}
                                    <span class="text-[9px] opacity-30">NO_ART</span>
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0 cursor-pointer"
                                 onclick="window.location.href='{{ url_for('track_detail', track_id=track.id) }}'">
                                <div class="flex items-start justify-between gap-4">
                                    <h4 class="text-sm serif-font leading-tight truncate">{{ track.title }}</h4>
                                    <span class="text-[9px] opacity-40 uppercase tracking-widest">{{ (track.source or '') }}</span>
                                </div>
                                <div class="mt-1 text-[10px] opacity-50 uppercase tracking-widest">
                                    {% if track.artist %}{{ track.artist }}{% endif %}
                                    {% if track.duration_str %} Â· {{ track.duration_str }}{% endif %}
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <select class="bg-black border-2 border-[#222] p-2 text-xs focus:border-white outline-none font-pixel" 
                                        onchange="addTrackToPlaylist('{{ track.id }}', this.value)">
                                    <option value="">Add to Playlist...</option>
                                    {% for playlist in playlists %}
                                        <option value="{{ playlist.id }}">{{ playlist.name }}</option>
                                    {% endfor %}
                                </select>
                                <button class="btn-outline text-[9px] tracking-widest bg-red-600/20 border-red-600/40 text-red-300 hover:bg-red-600/40 px-2 py-1" 
                                        onclick="event.stopPropagation(); deleteTrack('{{ track.id }}')" 
                                        title="ì‚­ì œ">DELETE</button>
                            </div>
                        </div>
                    </article>
                {% endfor %}
            </div>
        </section>
    {% endif %}

    {% if playlists %}
        <section class="space-y-6" id="playlistsList">
            {% for playlist in playlists %}
                <article class="pixel-card p-6 hover:border-white/40 transition-all playlist-item" 
                         data-playlist-id="{{ playlist.id }}">
                    <div class="flex gap-5 items-center">
                        <div class="w-20 h-20 bg-white/5 border border-white/10 flex items-center justify-center overflow-hidden">
                            {% if playlist.icon_url %}
                                <img src="{{ playlist.icon_url }}" alt="icon" class="w-full h-full object-cover">
                            {% else %}
                                <span class="text-2xl opacity-30">ğŸ“€</span>
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0 cursor-pointer"
                             onclick="window.location.href='{{ url_for('playlist_detail', playlist_id=playlist.id) }}'">
                            <h3 class="text-xl serif-font mb-2">{{ playlist.name }}</h3>
                            {% if playlist.description %}
                            <p class="text-sm opacity-50 mb-2">{{ playlist.description }}</p>
                            {% endif %}
                            <p class="text-[10px] opacity-30">{{ playlist.created_at[:10] if playlist.created_at else '' }}</p>
                        </div>
                        <div class="flex items-center gap-2 edit-mode-actions" style="display: none;">
                            <button class="btn-outline text-[10px] tracking-widest bg-red-600/20 border-red-600/40 text-red-300 hover:bg-red-600/40" 
                                    onclick="event.stopPropagation(); deletePlaylist('{{ playlist.id }}')" 
                                    title="ì‚­ì œ">DELETE</button>
                        </div>
                    </div>
                </article>
            {% endfor %}
        </section>
    {% else %}
        <section class="pixel-card p-10 text-center">
            <h3 class="text-xl serif-font mb-2">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-sm opacity-50 italic serif-font">ìƒˆ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ìƒì„±í•´ë³´ì„¸ìš”.</p>
        </section>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
let globalEditModeActive = false;

function toggleGlobalEditMode() {
    globalEditModeActive = !globalEditModeActive;
    const editBtn = document.getElementById('globalEditBtn');
    const allEditActions = document.querySelectorAll('.edit-mode-actions');
    
    if (globalEditModeActive) {
        editBtn.textContent = 'DONE';
        editBtn.classList.add('bg-green-600/20', 'border-green-600/40', 'text-green-300');
        allEditActions.forEach(actions => actions.style.display = 'flex');
    } else {
        editBtn.textContent = 'EDIT';
        editBtn.classList.remove('bg-green-600/20', 'border-green-600/40', 'text-green-300');
        allEditActions.forEach(actions => actions.style.display = 'none');
    }
}

async function createPlaylist() {
    const btn = document.getElementById('createPlaylistBtn');
    const msg = document.getElementById('createPlaylistMsg');

    btn.disabled = true;
    btn.textContent = 'CREATING...';
    msg.textContent = '';

    try {
        const res = await fetch('/api/playlists', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})  // ê¸°ë³¸ ì´ë¦„ìœ¼ë¡œ ìë™ ìƒì„±
        });
        const data = await res.json();
        if (data.success) {
            window.location.href = `/playlist/${data.playlist_id}`;
            return;
        }
        msg.textContent = data.error || 'ìƒì„± ì‹¤íŒ¨';
    } catch (e) {
        msg.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.';
    } finally {
        btn.disabled = false;
        btn.textContent = '+ CREATE NEW PLAYLIST';
    }
}

async function addTrack() {
    const input = document.getElementById('trackUrl');
    const btn = document.getElementById('addTrackBtn');
    const msg = document.getElementById('addTrackMsg');

    const url = (input.value || '').trim();
    if (!url) {
        msg.textContent = 'URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'ADDING...';
    msg.textContent = '';

    try {
        const res = await fetch('/api/tracks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url})  // playlist_id ì—†ì´ ì¶”ê°€
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
            return;
        }
        msg.textContent = data.error || 'ì¶”ê°€ ì‹¤íŒ¨';
    } catch (e) {
        msg.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ADD_TRACK';
    }
}

async function addTrackToPlaylist(trackId, playlistId) {
    if (!playlistId) {
        return;
    }
    
    try {
        const res = await fetch(`/api/tracks/${trackId}/playlist`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({playlist_id: playlistId})
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (e) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function deleteTrack(trackId) {
    if (!confirm('ì •ë§ ì´ ê³¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }
    
    try {
        const res = await fetch(`/api/tracks/${trackId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (e) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

async function deletePlaylist(playlistId) {
    if (!confirm('ì •ë§ ì´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì˜ ëª¨ë“  ê³¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) {
        return;
    }
    
    try {
        const res = await fetch(`/api/playlists/${playlistId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await res.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (e) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}
</script>
{% endblock %}




